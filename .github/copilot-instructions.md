# Copilot Instructions - Habit Tracker

## Project Overview
Flutter mobile habit tracker with Firebase Authentication and local per-user persistence. Simple architecture: no state management libraries, direct service layer calls from StatefulWidgets.

## Architecture
- **Authentication**: Firebase Auth (Google + Apple Sign-In) via `AuthService`
- **Data Flow**: Screen → Service (HabitStorage/NotificationSettingsService/ThemeService) → SharedPreferences → JSON
- **State**: StatefulWidget with local state (`setState`), no BLoC/Provider/Riverpod
- **User Isolation**: All storage services accept `userId` parameter for user-scoped keys (pattern: `key_name_$userId`)
- **Navigation**: BottomNavigationBar in MainNavigationScreen for tabs; `Navigator.push` for modals

## Code Organization
```
lib/
├── firebase_options.dart  # Firebase config (generated by flutterfire_cli)
├── main.dart              # App entry + AuthWrapper StreamBuilder
├── models/                # Immutable data models with toJson/fromJson/copyWith
│   ├── habit.dart         # Habit model with icon/color support
│   ├── notification_settings.dart
│   └── user.dart
├── services/              # Storage + business logic
│   ├── auth_service.dart  # Firebase Auth (Google/Apple)
│   ├── habit_storage.dart # User-scoped habit CRUD
│   ├── notification_settings_service.dart
│   ├── theme_service.dart
│   └── time_service.dart  # Singleton for test time manipulation
├── screens/               # Full-page StatefulWidgets
└── widgets/               # Reusable UI (HabitItem shows 5-day history)

docs/                      # All documentation files except README.md
```

## Documentation Guidelines
- **All documentation files must be placed in the `docs/` folder**
- Only `README.md` stays at the project root
- Use relative links between docs (e.g., `[FIREBASE_SETUP.md](docs/FIREBASE_SETUP.md)`)
- From README.md, link to docs with `docs/` prefix (e.g., `[docs/AUTH_README.md](docs/AUTH_README.md)`)

## Key Patterns

### Firebase Authentication
Main app uses StreamBuilder on `AuthService.authStateChanges` to route between LoginScreen and authenticated screens:
```dart
StreamBuilder(
  stream: authService.authStateChanges,
  builder: (context, snapshot) => snapshot.hasData 
    ? MainNavigationScreen(userId: snapshot.data!.uid) 
    : LoginScreen()
)
```
Setup requires: `flutterfire configure` (see [docs/FIREBASE_SETUP.md](docs/FIREBASE_SETUP.md), [docs/AUTH_README.md](docs/AUTH_README.md))

### User-Scoped Storage Pattern
All services use optional `userId` parameter to scope data per-user:
```dart
final storage = HabitStorage(userId: currentUser.uid);  // Key: 'habits_$userId'
final settings = NotificationSettingsService(userId: currentUser.uid);
```
Without userId, falls back to global key. Always pass userId from MainNavigationScreen/HomeScreen.

### Habit Model (Immutable)
- Uses `copyWith()` for updates, not setters
- DateTime completions stored as `List<DateTime>`, normalized to midnight
- JSON serialization via `toJson()`/`fromJson()` factory methods
- Includes `icon` (emoji, default '✓') and `colorValue` (int from `Habit.habitColors` palette)
- Example: `habit.copyWith(completions: [...habit.completions, today])`

### Storage Service Pattern
Every screen operation follows:
```dart
final storage = HabitStorage(userId: userId);  // Pass userId!
await storage.loadHabits();        // READ
await storage.addHabit(habit);      // CREATE
await storage.updateHabit(habit);   // UPDATE
await storage.deleteHabit(id);      // DELETE
```
After mutations, screens call `_loadHabits()` to refresh UI.

### Date Normalization
Always normalize dates to midnight before comparison:
```dart
final today = DateTime(now.year, now.month, now.day);
```
Completions are checked by comparing year/month/day components, not DateTime equality.

### TimeService Singleton
Singleton service for test time manipulation. Always use `TimeService().now()` instead of `DateTime.now()`:
```dart
final now = TimeService().now();  // Can be offset by hours in tests
final today = DateTime(now.year, now.month, now.day);
```
Must call `await TimeService().loadOffset()` in initState before first use.

### 5-Day Completion View
HabitItem displays last 5 days in a horizontal row (today on right), with date-specific toggle:
```dart
HabitItem(
  habit: habit,
  onToggle: () => _toggleCompletion(habit),      // Toggles today
  onToggleDate: (date) => _toggleCompletion(habit, date),  // Toggles specific date
  onDelete: () => _deleteHabit(habit.id),
)
```
Toggle methods accept optional `DateTime? date` parameter for past-day marking.

### Theme Management
Theme changes propagate via callback: HabitsApp → AuthWrapper → MainNavigationScreen → SettingsScreen:
```dart
// HabitsApp._updateThemeMode updates state and persists via ThemeService
MaterialApp(themeMode: _themeMode, ...)
```
ThemeService stores preference as string ('light'/'dark'/'system') in SharedPreferences key 'theme_mode'.

### Habit Icon Selection
AddHabitScreen provides 24 predefined emojis in wrap layout. Selected icon stored in Habit.icon field (default '✓').

### Conditional Settings Controls
Settings screens disable dependent controls when master toggle is off:
```dart
ListTile(
  enabled: settings.enabled,  // Greyed out when master toggle off
  onChanged: settings.enabled ? (val) => _updateSetting(val) : null,
)
```

### Streak Calculation
Streaks count consecutive days backwards from today. Implementation in `HabitItem._getCurrentStreak()` sorts completions descending and checks for consecutive dates.

### Calendar Single-Habit Filter
CalendarScreen uses single-select filter (`String? _selectedHabitId`) with RadioListTile for habit selection. All calendar data displays for one habit at a time:
```dart
// Initially selects first habit
_selectedHabitId = widget.habits.first.id;

// Filter shows only selected habit
List<Habit> get _filteredHabits => widget.habits
  .where((habit) => habit.id == _selectedHabitId).toList();
```
Dialog title: "Select Habit" (singular). Filter chip shows selected habit's name and icon, clickable to open selector.

## UI Conventions
- **Material 3**: Uses `ColorScheme.fromSeed(seedColor: Colors.deepPurple)` with `useMaterial3: true`
- **Dismissible**: Swipe-to-delete requires `confirmDismiss` with AlertDialog
- **Empty States**: Show large icon + message when no data (see HomeScreen body)
- **Loading States**: Always show `CircularProgressIndicator` during async operations
- **Navigation**: BottomNavigationBar in MainNavigationScreen switches between Home/Calendar/Settings tabs
- **Settings Access**: Settings icon in AppBar leading position navigates to SettingsScreen with ListView of ListTiles
- **TODO Placeholders**: Use SnackBar with "TODO: ..." message for unimplemented features in onTap callbacks

## Development Workflow

### Firebase Setup
```bash
dart pub global activate flutterfire_cli
flutterfire configure  # Generates firebase_options.dart
# Add google-services.json (Android) or GoogleService-Info.plist (iOS)
```

### Run/Test Commands
```bash
flutter pub get           # Install dependencies
flutter run              # Run on connected device/emulator
flutter test             # Run all tests
flutter test test/habit_test.dart  # Run specific test file
flutter analyze          # Run linter (CI enforces)
```

### Common Tasks
- **Add new feature**: Start with model changes, update storage if needed, then UI
- **Modify date logic**: Check HabitItem widget for existing date normalization patterns
- **Add persistence**: Extend storage service, always use JSON serialization and user-scoped keys

## Testing Strategy
- **Unit tests**: Model serialization/deserialization (see `test/habit_test.dart`)
- **Service tests**: Must use `SharedPreferences.setMockInitialValues({})` in setUp for all storage-dependent tests
- **Widget tests**: Must wrap tested widgets in `MaterialApp` and `Scaffold` for proper rendering/theming
- **CI**: GitHub Actions runs `flutter test` + `flutter analyze` on push/PR (see `.github/workflows/flutter-test.yml`)
- No integration tests; manual testing on device/emulator

## Linting
Enforces `prefer_const_constructors` and `prefer_const_literals_to_create_immutables` via `analysis_options.yaml`. Use `const` wherever possible for constructors and collections.

## Dependencies
- `firebase_core: ^3.8.1`, `firebase_auth: ^5.3.4` - Firebase Authentication
- `google_sign_in: ^6.2.2` - Google Sign-In
- `sign_in_with_apple: ^6.1.4` - Apple Sign-In (iOS 13+/macOS 10.15+/web)
- `shared_preferences: ^2.2.0` - Local key-value storage
- `intl: ^0.19.0` - Date formatting (minimal usage)
- No state management, routing, or dependency injection libraries

## Gotchas
- **State refresh**: Must manually reload data after storage mutations (no automatic reactivity)
- **DateTime comparisons**: Always normalize to midnight; don't compare DateTime objects directly
- **TimeService**: Always use `TimeService().now()` instead of `DateTime.now()` for testability
- **User scoping**: Always pass `userId` to storage services from authenticated screens
- **Habit IDs**: Generated as timestamps (`DateTime.now().millisecondsSinceEpoch.toString()`) in AddHabitScreen, not UUIDs
- **Interval field**: String enum ('daily', 'weekly', 'monthly'), not actual enum type
- **Theme propagation**: Changes must propagate up via callbacks, no reactive state management
